name: Check input files for validity

on: 
  [push, pull_request]

permissions:
  contents: read

jobs:
  check-bom:
    uses: Open-Systems-Pharmacology/Workflows/.github/workflows/Check_BOM.yml@main
          
  utf8check:
    uses: Open-Systems-Pharmacology/Workflows/.github/workflows/UTF8Check.yml@main
    with:
      file-extensions: 'R\|json\|md'  #File extension(s) to check separated by \| Examples:
                                      #R
                                      #R\|json

  Spellcheck:
    uses: Open-Systems-Pharmacology/Workflows/.github/workflows/SpellChecker.yml@main
    
  Validate-Evaluation-Plan:
    uses: Open-Systems-Pharmacology/Workflows/.github/workflows/ValidateQualificationPlan.yml@main
    with:
      qualification-plan: 'Evaluation/Input/evaluation_plan.json'

  test-check-bom:
    runs-on: ubuntu-latest
    steps:
      - name: Test Check for BOM in CSV, JSON and MD files
        shell: bash
        run: |
          shopt -s globstar
          shopt -s nocaseglob
          bom_found=false
          for file in **/*.csv **/*.json **/*.md; do
            if [ -f "$file" ]; then
              bom=$(hexdump -n 3 -e '/1 "%02x"' "$file")
              if [ "$bom" = "efbbbf" ]; then
                echo "Error: File $file has a BOM"
                echo "::error file=$file::File has BOM"
                bom_found=true
              else
                echo "File $file is valid"
              fi
            fi
          done
          if [ "$bom_found" = true ] ; then
            echo "At least one file has BOM, failing the action"
            exit 1
          fi
      